from django import forms
from django.http import JsonResponse
from django.views.decorators.http import require_POST

from puzzles.views.auth import validate_puzzle

TEXT = """buffer
NOTANANSWER
DUD
RECTANGULAR
INN
WATERFALL
CLIP
LECTURER
SHRINE
SURRENDER
ELEVEN
CURRENTLY
FOREMOST
ACCESSIBILITY
PAD
STIMULUS
CORONARY
COMPLETION
DEFENDER
UNHEALTHY
MICRO
TRAGIC
WHATSOEVER
SPEED
SHORTEN
NINETEENTH
ABANDON
REBEL
REFINED
AVERAGE
CHEAT
SPLASH
OPT
POSSIBILITY
COLLECTIVE
JEANS
PRECISION
SHAPE
PROSPEROUS
SPIRITUAL
ROAR
BIOLOGICAL
ALTERNATE
CONTENT
TALENTED
PERSUASION
TRADE
ORNAMENT
PATH
OUTRAGEOUS
ROVER
HUMBLE
TIMELY
EMPLOYMENT
INFECT
SECURE
INSECT
ISLAM
UNEMPLOYED
MOTIVATE
UNDERNEATH
MOTH
TUBE
MATURITY
OFFSET
AMBIGUOUS
TOURNAMENT
TREASURE
NONEXISTENT
CAUSAL
WARRANT
STRESS
TIER
LIFTING
GAME
BLUNT
START
BOXING
CHEERFUL
STROKE
QUESTIONING
PE
PACE
DAGGER
FULFIL
STRONGLY
INTENSITY
TV
TRANS
WITHSTAND
VERIFY
IRISH
SHAMPOO
PETITION
CACHE
BATTLEFIELD
CONVENIENTLY
SUCKER
FURNISH
SEQUEL
CUFF
LABRADOR
LIMIT
HORROR
BEARING
CLEARLY
HISTORIC
EARLIER
ENTAIL
ILLEGAL
CRAM
FOLLOWER
UNIT
RAINFALL
ADORE
WARBLER
DECREE
CIRCULAR
SUSTAINED
GUILDHALL
LONGING
TORTILLA
WISH
SHAREHOLDER
SCORE
BARRIER
STRAP
LOLLIPOP
SPLIT
SURVEILLANCE
ASTEROID
REPORTEDLY
INADEQUATE
CHRYSLER
CROP
DRILL
SILENCE
LARGER
GYPSY
REPERTOIRE
NOBODY
BALLROOM
DEBACLE
SYLLABLE
RESPONSE
EXPLORER
THOUSAND
TERRITORY
CONCUR
VULNERABLE
JELLY
SALMONELLA
IRRIGATION
BALLPARK
WORRY
INTERNATIONALLY
FACET
HORRIBLE
COMPLETE
GIRLFRIEND
NERVOUSLY
PLURAL
REFRIGERATOR
REVOLVER
SEAL
ALLERGIC
PARTICULARLY
REGULAR
STRATEGIST
FERTILIZER
CURB
CRITICALLY
BRACKET
ARBITRARY
HOSTESS
FLOTILLA
EMBARK
HIERARCHICAL
BLIZZARD
MARTINI
MEASURE
ATTEND
VEGGIE
RETROSPECTIVE
PROGRAM
CHAIR
LEAGUE
CLASSIFIED
INFLATE
GOVERNING
CHAIRMAN
LIABLE
LOW
LEARNING
CONDO
GEOLOGICAL
HAPPINESS
CORRECT
ABDUCT
BLINK
SADLY
RATING
PASTRY
SORROW
INSULIN
WORTH
UNUSUALLY
REGARDING
VICE
SOPHOMORE
DESERVING
TUMOR
POTENTIAL
VARIANCE
WORKSHOP
SPRAY
BOND
CONVICTED
VISUALIZE
BARK
COVE
CONSOLE
CAMPAIGN
SHRUB
SUFFICE
ORGANIZE
SPHERE
HORDE
PROTECTIVE
HIDDEN
RARE
FOCAL
DIVE
TURNING
ROUND
INTELLIGENCE
INCARCERATION
LOVING
DISCOUNT
PARTICIPANT
SEVENTEEN
JOKE
WOLF
GUM
LYRICS
OUTRAGED
FEARFUL
FUTURE
THEME
BLUE
UNDERSTANDING
LEADING
CONTACT
SLIM
RESTART
CRUELTY
PER
OBSERVER
MATTRESS
EXAGGERATE
UNSUCCESSFUL
FRAMEWORK
COOPERATION
SOVEREIGNTY
PSYCHIATRIST
UNCONSTITUTIONAL
LIGHT
LAG
FRY
DISTRICT
PLEDGE
NEIGHBORING
DETAINEE
EXISTING
OBLIGE
ENDORSEMENT
DISPOSE
INFANTRY
COFOUNDER
HATE
LOGISTICS
ETERNAL
THOROUGH
SPECIFY
RHETORIC
DEGREE
FUCKING
RENT
INJECT
AFFECTION
INSCRIPTION
MARINE
PACT
EMPHASIS
DOWN
BOSNIAN
SHEPHERD
MAINLAND
PAINT
HANDHELD
RECRUIT
DEVISE
IE
CHANT
MAXIMUM
CRAWL
STERN
PROCEEDINGS
SIDEWAYS
BEETLE
SECRET
BOILING
FINGERNAIL
CLEANSE
ENCOUNTER
BOWLING
GLOWING
COMMIT
NOTABLE
RECEPTION
PROFESS
DEFINITELY
MANTRA
IMMUNE
RADICAL
INTIMIDATE
RETALIATION
PASTURE
LINEAGE
WAVE
GREENHOUSE
SCIENTIFICALLY
PANCAKE
LOFT
REGISTERED
HORIZON
RIBBON
MEAN
AUBURN
VERTICAL
LIGHTHOUSE
MOMENTUM
ALTITUDE
MARCH
SUPERIOR
CHEMISTRY
PULL
RESILIENCE
UNDERGO
MELT
ABBEY
PROFILE
REAPPEAR
FOSTER
SPILL
PHYSICIST
DESIGN
CLOUD
DEFECT
NOVICE
CREEK
BLESS
WAREHOUSE
RITUAL
BISHOP
GRENADE
RELIC
FORGOTTEN
REMOTELY
INCLUSIVE
LAST
PARDON
STATUTORY
IMMORTAL
LEAD
SAIL
PARANOIA
ANSWERING
JUNK
PREMIER
OCEAN
EXPAND
RIG
CRISIS
FREE
SUIT
WATCH
PLEASING
CLOCK
EXCHANGE
YIELD
PRIVILEGE
PREPARED
ALERT
CONCESSION
HANGING
INSTRUCTIONAL
SHELF
DUST
SELECTED
ENFORCE
AH
EAGLE
SUBSIDY
LOOSEN
CRUEL
CHROME
PRESUME
ATM
WILDLY
DIRE
CROW
CHALK
DRIFT
LINEBACKER
BIOLOGIST
PROSE
ASSET
INTERVIEW
CUBE
NARRATIVE
VEGETARIAN
PHARMACY
STRANGLE
DEACON
ELECTED
INFLAMMATORY
SUPPOSEDLY
CLASSIFY
BULLDOG
EXAMPLE
BINDING
MOUNT
TRAJECTORY
LIGHT
HURRY
MAILBOX
SPIKE
DEPENDENCY
FORMIDABLE
COMMEND
PUMP
GRACEFUL
CARBON
DEEP
THUG
SURGE
GORGEOUS
LOCK
RIFT
COMMENT
STUDY
SELFESTEEM
HAPPILY
MIXED
SEXIST
ROBE
SHERIFF
FOOL
IDENTIFY
BLACK
DISLIKE
SUPPOSE
TYPICAL
SMOOTHLY
NOWHERE
COUGH
DEVOTE
PLUS
SIGNAL
DIVINE
BOARD
PRESENT
DISSATISFACTION
STEREOTYPE
EARTH
REGULATE
MEDICINE
PAPERBACK
SCOTTISH
GUIDELINE
SHALLOW
SANDWICH
ANSWER
ANDROID
FORTY
CORRESPOND
GREEN
STRIKE
STARTER
PROCESSING
HORMONE
UNDERCOVER
FRAUD
AGREEMENT
OOH
AUTHORIZE
LUTHERAN
SUPERVISOR
EXCEPTIONALLY
ETHANOL
SCREEN
FALLOUT
DWELL
SIZE
BRAVE
ASSOCIATE
POSITIVELY
SINGING
FANCY
VOLTAGE
SPINE
PEAK
LEATHER
CLOUD
UNABLE
STRAIGHTEN
BENEFIT
CAUTION
ANGEL
AROMA
OVEN
LATIN
AFRICAN
IP
HARVEST
GUIDED
RUN
HACKER
EMPLOYEE
SAW
PARTTIME
INNOCENT
STRIDE
EXPLODE
CREED
UNTO
INTENDED
FERTILITY
PARTICLE
POLITE
LEMON
ANECDOTE
ANGRILY
ACCESS
SEWER
UNAWARE
DARKEN
BAKE
PROTECTOR
NEGLECT
TWEAK
CONDITION
BREEZE
PREVAIL
UNDECIDED
ENDURE
STRUCTURE
MESS
AMID
LEAK
INK
MARIJUANA
IDEOLOGICAL
CASTING
MEDIOCRE
ALMOND
ULTRASOUND
LEISURE
GUARD
SUBMIT
BAKERY
DATE
LOOSE
GUITAR
HABIT
AGENCY
PITCHER
HOMELESS
RELAY
METHODIST
MODIFICATION
CHAMPION
RIGOROUS
LIGHTER
UNNECESSARY
MAXIMIZE
DOCUMENT
SYRIAN
RACIST
ENRICHMENT
MUTUAL
REAFFIRM
SIMPLE
CAUCUS
REOPEN
PREFERENCE
TOUR
RAPIDLY
SOCK
SUCCUMB
STUPID
CONFIRM
CONGRATULATIONS
HAZARDOUS
TEASE
SETTLER
DISTINCTIVE
BEATING
CONSPIRACY
SHELTER
PASSENGER
FLYER
EXPLOSION
SOLVE
TRIBUNE
JURY
FORGE
DEMOGRAPHICS
HOMEOWNER
CREATIVITY
STUNNING
UPGRADE
REFERENCE
SUITABLE
ASLEEP
WORRY
TACKLE
BUS
GROUPING
BALCONY
PEEK
SERUM
INDICATE
FORTH
EXPERIMENT
UPGRADE
RULING
STRANGELY
ECOSYSTEM
BOMBING
RANCH
BUFFER
SLEEP
CHECKPOINT
CONTAMINATION
SCRAP
OAK
COPY
SPIDER
ROSE
CURTAIL
SPECIALIST
JEEP
PACK
TERRITORIAL
PLUMBING
TUTOR
SWEETIE
PLEASURE
ADMINISTER
PROPER
OKAY
UNIFY
EXPLOITATION
ENVY
ENCOURAGE
SEXISM
SERIOUS
CRESCENT
WIDOW
UNAUTHORIZED
APPLICABLE
RELEGATE
WHOLE
UPHOLD
GOVERNANCE
MOUNT
COMMON
HUMIDITY
DROWN
SCAM
CONSCIOUS
LETHAL
SUSPECT
STRAND
EQUITABLE
DISASTER
COWARD
PREVAILING
DRIP
FAT
FAR
PEAK
CONSUMPTION
BASIS
MOLD
EMPHASIZE
EXTRACT
GRUNTING
STATISTIC
PAINFUL
SPIN
DUB
WHOO
ENDANGERED
HARMLESS
SWAMP
RELIEVE
NEITHER
WHENEVER
BEHAVIORAL
PREPARATION
BEAT
SHIP
BESIDES
EXPERIMENTATION
TEASPOON
PLATOON
BEER
BYE
SWIM
GENERATING
THEREFORE
EXPERT
AFFILIATE
ORIGINAL
PROP
EGG
GERM
SUICIDAL
TICKET
LILY
SPERM
TEMP
CIRCULATE
PHILOSOPHY
SELECTIVE
UNDERWEAR
HAUL
BEND
SUBSTANTIAL
REPLICATE
SLAM
SPOILER
GREED
DUMP
TACTICAL
GREET
LEASH
SOLDIER
ACCESSIBLE
GREEDY
MIST
GRAVEL
FRIED
SINCE
GAMING
DEMONSTRATION
HOMESTEAD
MINIMAL
USEFUL
BRINK
AVOIDANCE
ERODE
UNCOVER
FAVORITE
STRIKE
DINER
SMOKING
SALESMAN
INITIAL
JUICE
BROCCOLI
UNEXPECTED
EXTINCTION
MESSAGING
BANK
GLADLY
JOURNALISTIC
OUTSKIRTS
ORIGIN
PARAMETER
GENUINE
MARSH
TRAIL
ESSENCE
AMEN
BIAS
WORTHLESS
SURGICAL
ATTACHMENT
EXERT
PEST
DISTANCE
PIN
PROSECUTE
PROVOKE
SUPREME
NICKNAME
COMMITMENT
NEUTRON
MUDDY
MAYOR
EVADE
SWISS
NEEDLESS
BLOOD
PREHEAT
FLAT
IDOL
SCAR
DESERT
FESTIVAL
REDEFINE
INTERESTINGLY
BRIGHTEN
VARIETY
REVIEWER
LISTENING
COLONIST
TEMPERATURE
BACKUP
RELUCTANT
RISK
MATRIX
MUTTER
CONSTITUTIONAL
TOUCHDOWN
WIG
FOG
SURFACE
REPETITIVE
PHYSICALLY
CELESTIAL
ACTING
TROUBLED
HEADLIGHT
HAMMER
TOUCH
MINGLE
TRAIN
GRADUATE
CORD
FAN
MOTION
CABIN
TORTURE
TODDLER
NAUSEA
SUMMARIZE
FREAK
DRAW
DONATION
UPWARD
DOT
BREATHE
CAMERA
SERIES
REFLECTIVE
DOLL
NAVY
THEOLOGIAN
THICK
SECT
REACTOR
COMPUTATIONAL
AMIDST
CONDUCT
REEL
SQUASH
WATER
SURVEY
SODA
FRACTURE
FACILITY
BLUR
POPULAR
LONGTERM
ACCENT
BUZZ
MANAGING
HILARIOUS
PUTT
DIARY
HANDOUT
GRIND
HOT
PARALYZE
LOUSY
TRICKLE
SHRINK
INTERVIEWER
ATTENDANCE
LAYER
EVACUATE
FASHIONABLE
SPECIALLY
ADEQUATELY
INTERPRET
OVERT
MAILING
ZOOM
PINPOINT
BROCHURE
RUSTY
CASH
SURELY
LITERALLY
ASTRONAUT
OUNCE
ANT
CREDENTIAL
YEAST
COLUMN
RESPONSIBLE
SOLICIT
TUTORIAL
SENATE
KNOCK
REASON
DIAL
SUPPLEMENT
HAMMER
DENT
DEVOID
LINKAGE
SHOWER
TILT
OBSTRUCT
RECONSTRUCT
YOGURT
STRAIT
SALTY
LEAF
PARADIGM
FULLTIME
BAILOUT
HMM
COOPERATE
POWERHOUSE
INTEREST
TESTING
TRADE
RECREATE
FLOATING
SADDLE
DOUBT
SURGERY
CAPACITY
YOURS
CLOVE
DESIGN
REDUCTION
DEBATE
ADOPTION
REACT
HOMEMADE
BEAST
SACRAMENT
OWNERSHIP
PURELY
ATHEIST
DOWNWARD
PROTESTANT
PROFICIENCY
OUTWEIGH
ACCIDENTALLY
VERSATILE
OUTRAGE
UNION
UNPREDICTABLE
CATHOLICISM
DIPLOMAT
BORN
DEAR
AUSTERITY
BUG
WISDOM
VARYING
FLOW
JUMP
OUTFIT"""
ALPHABET = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz .!"


class InfBookPageForm(forms.Form):
    page = forms.IntegerField(min_value=1, max_value=1e100, required=True)


class InfBookEncodeForm(forms.Form):
    message = forms.CharField(max_length=100, required=True)

    def clean(self):
        message = self.cleaned_data.get("message", "")
        if not all(c in ALPHABET for c in message):
            msg = "Invalid characters in message"
            raise forms.ValidationError(msg)


class Evaluator:
    def __init__(self):
        self.words = TEXT.strip().split("\n")
        self.encdict = {
            "p": "cu",
            "c": "sy",
            "s": "ui",
            "u": "dm",
            "d": "jk",
            "j": "wv",
            "w": "an",
            "a": "er",
            "e": "pd",
            "z": "mc",
            "m": "ii",
            "i": "yb",
            "y": "xl",
            "x": "fq",
            "f": "to",
            "t": "qo",
            "q": "lp",
            "l": "bd",
            "b": "zh",
            "r": "pw",
            "n": "rg",
            "h": "rj",
            "o": "ux",
            "k": "za",
            "g": "kl",
            "v": "xo",
            "A": "ou",
            "B": "bm",
            "C": "im",
            "D": "wh",
            "E": "so",
            "F": "ie",
            "G": "zs",
            "H": "bh",
            "I": "kj",
            "J": "qm",
            "K": "qa",
            "L": "id",
            "M": "oi",
            "N": "fa",
            "O": "zv",
            "P": "ft",
            "Q": "us",
            "R": "em",
            "S": "fz",
            "T": "og",
            "U": "ai",
            "V": "nr",
            "W": "ue",
            "X": "rr",
            "Y": "sf",
            "Z": "wl",
            " ": "yl",
            ".": "wf",
            "!": "nv",
        }

    def encode(self, s):
        return "".join([self.encdict[c] for c in s])

    def query_enc(self, msg):
        return self.encode(self.encode(msg))

    def make_congrats(self, n):
        ans = f"Congrats! The answer is {self.words[n]}."
        return ans.ljust(50)

    def compute_book(self, left, right, depth):
        if left < 50:
            msg = self.make_congrats(depth)
            if right <= 50:
                return msg[left:right]
            else:
                return msg[left:] + self.compute_book(50, right, depth)
        le = (left - 50) // 2
        ri = (right - 49) // 2
        result = self.encode(self.compute_book(le, ri, depth + 1))
        return result[left - 50 - 2 * le : right - 50 - 2 * le]

    def query_page(self, page: int):
        return self.compute_book(1000 * (page - 1) + 50, 1000 * page + 50, 0)


EVALUATOR = Evaluator()


@require_POST
def encode(request):
    form = InfBookEncodeForm(request.POST)
    if not form.is_valid():
        return JsonResponse({"form_errors": form.errors}, status=400)

    return JsonResponse(
        {"data": {"response": EVALUATOR.query_enc(form.cleaned_data["message"])}}
    )


@require_POST
def get_page(request):
    form = InfBookPageForm(request.POST)
    if not form.is_valid():
        return JsonResponse({"form_errors": form.errors}, status=400)

    return JsonResponse(
        {"data": {"page": EVALUATOR.query_page(form.cleaned_data["page"])}}
    )
